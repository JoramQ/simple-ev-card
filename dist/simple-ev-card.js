const t=["Charging Normal","Load Balancing Limited"],e="Home",r="Connected",n="Charging",s="Parked",i="Moving",a="#F44336";class o extends HTMLElement{constructor(){super(...arguments),this._prevBattery=null,this._prevRange=null,this._prevIsCharging=null,this._prevStatus=null,this._prevChargerStatus=null,this._prevChargingPower=null,this._carEvent=null,this._calendarFetchAttempts=0,this._calendarLastFetchTime=0,this.statusEl=null,this.batteryBar=null,this.batteryText=null,this.chargeBtn=null,this.eventEl=null,this.chargerEl=null,this.errorEl=null,this.displayInsideEl=null,this.cableEl=null,this.chargingPowerTextEl=null,this._svgChargerEls=null,this._svgParkingEls=null,this._svgDriverEls=null,this._svgMovingEls=null}_stateEquals(t,...e){if(null==t)return!1;const r=t.toLowerCase().trim();return e.some((t=>t.toLowerCase().trim()===r))}_stateIsOn(t){return this._stateEquals(t,"on","true","1","yes")}_isValidState(t){return null!=t&&""!==t&&"unavailable"!==t&&"unknown"!==t}_showError(t){this.errorEl&&(this.errorEl.textContent=t,this.errorEl.classList.remove("hidden")),console.error(`[simple-ev-card] ${t}`)}_clearError(){this.errorEl&&(this.errorEl.classList.add("hidden"),this.errorEl.textContent="")}_toggleSvgElements(t,e){t&&t.forEach((t=>t.classList.toggle("hidden",e)))}_parseServiceCall(t){if(!t||"string"!=typeof t)return null;const e=t.split(".");return 2===e.length&&e[0]&&e[1]?{domain:e[0],service:e[1]}:(this._showError(`Invalid service format: "${t}". Expected "domain.service"`),null)}_getLocationBooleans(t,e,r){const n=e=>{if("boolean"==typeof e)return e;if("string"==typeof e){const r=t.states[e];if(r)return this._stateIsOn(r.state);if("true"===e)return!0;if("false"===e)return!1}};let s=n(e.is_home),i=n(e.is_away),a=n(e.is_driving);if(void 0===s||void 0===i||void 0===a){const r=e.car_location_entity?t.states[e.car_location_entity]:void 0;if(r&&r.state){const t=this._stateEquals(r.state,"home"),e=this._stateEquals(r.state,"not_home");void 0===s&&(s=t),void 0===i&&(i=e),void 0===a&&(a=!t&&!e)}}return void 0===s&&void 0===i&&void 0===a&&r&&(s=!0,i=!1,a=!1),{isHome:s??!1,isAway:i??!1,isDriving:a??!1}}setConfig(t){this.config=t;const e=["car_battery_entity","car_cruising_range_entity","charger_connected_entity"].filter((t=>!this.config[t]));if(e.length)throw new Error("Missing required config keys: "+e.join(", "));const r=["car_battery_entity","car_cruising_range_entity","charger_connected_entity","calendar","charger_status","is_charging_entity","car_location_entity","car_charging_start_service","car_charging_stop_service","car_charging_power_entity"];for(const t of r){const e=this.config[t];if(void 0!==e&&"string"!=typeof e)throw new Error(`Config field "${t}" must be a string, got ${typeof e}`)}const n=["car_charging_start_data","car_charging_stop_data"];for(const t of n){const e=this.config[t];if(void 0!==e&&("object"!=typeof e||null===e||Array.isArray(e)))throw new Error(`Config field "${t}" must be an object`)}for(const t of["car_charging_start_service","car_charging_stop_service"]){const e=this.config[t];if(e&&!e.includes("."))throw new Error(`Config field "${t}" must be in format "domain.service", got "${e}"`)}if(void 0!==this.config.max_charging_power&&("number"!=typeof this.config.max_charging_power||this.config.max_charging_power<=0))throw new Error(`Config field "max_charging_power" must be a positive number, got ${this.config.max_charging_power}`);const s=["is_home","is_driving","is_away"];for(const t of s){const e=this.config[t];if(void 0!==e&&"boolean"!=typeof e&&"string"!=typeof e)throw new Error(`Config field "${t}" must be a boolean or entity ID string, got ${typeof e}`)}this.innerHTML='\n      <ha-card>\n        <style>\n          .carcard_container {\n            position: relative;\n            width: 100%;\n            display: flex;\n            flex-direction: column;\n            padding-bottom: 10px;\n          }\n          .carcard_image {\n            width: 100%;\n            height: auto;\n            display: block;\n          }\n          .carcard_overlay {\n            position: absolute;\n            top: 8px;\n            left: 12px;\n            padding: 4px 12px;\n            font-size: var(--ha-card-header-font-size, 24px);\n            font-family: var(--ha-card-header-font-family, inherit);\n            color: var(--ha-card-header-color,var(--primary-text-color));\n            letter-spacing: -0.012em;\n            z-index: 2;\n          }\n\n          .carcard_battery_bar_container {\n            position: relative;\n            margin: 10px;\n            height: 30px;\n            background-color: rgba(0,0,0,0.25);\n            border-radius: 15px;\n            overflow: hidden;\n          }\n          .carcard_battery_bar_background {\n            position: absolute;\n            top: 0;\n            left: 0;\n            height: 100%;\n            width: 0%;\n            background-color: red;\n            transition: width 0.3s ease, background-color 0.3s ease;\n            border-radius: 15px 0 0 15px;\n          }\n          .carcard_battery_bar_text {\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: white;\n            font-weight: bold;\n            font-size: 16px;\n            text-shadow: 1px 1px 2px black;\n          }\n\n          .charge_button {\n            margin: 10px;\n            padding: 7px;\n            border: none;\n            border-radius: 10px;\n            font-size: 14px;\n            cursor: pointer;\n            background-color: #2196F3;\n            color: white;\n            box-shadow: 0 2px 5px rgba(0,0,0,0.3);\n            transition: background-color 0.3s ease;\n          }\n          .charge_button:hover {\n            background-color: #1976D2;\n          }\n          #car_event {\n            text-align: center;\n          }\n          .hidden {\n            display: none !important;\n          }\n          svg .green {\n            fill: #62e027ff !important;\n          }\n          svg .display_inside {\n            transition: clip-path 0.5s ease;\n          }\n          svg .charging-power-text {\n            font-size: 10px;\n            font-weight: bold;\n            fill: var(--primary-text-color);\n            text-anchor: middle;\n          }\n          svg .svg_charger,\n          svg .svg_parking,\n          svg .svg_carbody,\n          svg .svg_carhandles,\n          svg .svg_carwheels,\n          svg .svg_driver,\n          svg .svg_moving,\n          svg .svg_cable {\n            fill: var(--primary-text-color);\n          }\n          .bottom_row {\n            display: flex;\n            align-items: center;\n          }\n          #charger_status {\n            flex: 1;\n            margin-left: 20px;\n          }\n          .actions {\n            margin-left: auto;\n          }\n          .carcard_error {\n            background-color: rgba(244, 67, 54, 0.9);\n            color: white;\n            padding: 8px 12px;\n            margin: 10px;\n            border-radius: 8px;\n            font-size: 14px;\n            text-align: center;\n          }\n        </style>\n        <div class="carcard_container">\n          <svg viewBox="0 0 400 200" preserveAspectRatio="none" class="carcard_image">\n            <path class="svg_charger body hidden" d="M0,0 L35,0 L41,3 L46,9 L47,12 L47,131 L52,131 L54,133 L54,144 L52,146 L-18,146 L-19,145 L-19,133 L-16,131 L-12,131 L-12,11 L-8,5 L-3,1 Z M1,6 L-5,10 L-7,15 L-7,131 L41,131 L41,13 L36,7 L34,6 Z M-13,137 L-13,141 L48,141 L48,137 Z " transform="translate(331,47)"/>\n            <path class="svg_charger display_inside hidden" style="fill: transparent" d="M0,6 L3,35 L26,35 L26,6 Z " transform="translate(334,58)"/>\n            <path class="svg_charger display hidden" d="M0,0 L28,0 L32,4 L32,37 L30,40 L27,41 L1,41 L-3,38 L-3,3 Z M3,6 L3,35 L26,35 L26,6 Z " transform="translate(334,58)"/>\n            <path class="svg_charger icon hidden" d="M0,0 L2,0 L1,7 L5,7 L4,12 L-1,18 L-3,17 L-2,11 L-6,11 L-5,6 Z " transform="translate(349,70)"/>\n            <path class="svg_charger connector hidden" d="M0,0 L7,0 L11,4 L12,6 L12,15 L8,20 L-1,20 L-5,16 L-5,4 Z M2,6 L1,7 L1,14 L5,15 L6,14 L6,7 Z " transform="translate(345,116)"/>\n            <text class="charging-power-text hidden" id="charging_power_text" x="351" y="110"></text>\n\n            <path class="svg_parking hidden" style="scale:0.8" d="M0,0 L52,0 L56,4 L57,6 L57,56 L54,61 L51,63 L29,64 L29,81 L28,91 L24,88 L23,63 L0,63 L-4,59 L-5,56 L-5,5 Z M5,4 L0,7 L0,55 L2,58 L49,58 L52,55 L52,8 L50,5 L45,4 Z " transform="translate(322,18)"/>\n            <path class="svg_parking hidden" style="scale:0.8" d="M0,0 L15,0 L22,3 L25,6 L26,14 L23,19 L19,22 L7,23 L6,34 L0,34 L-1,1 Z M7,6 L6,7 L6,16 L7,17 L15,17 L19,13 L18,8 L16,6 Z " transform="translate(337,32)"/>\n\n            <path class="svg_carbody" d="M0,0 L36,0 L58,1 L78,4 L92,11 L105,21 L116,29 L130,34 L134,39 L134,63 L133,81 L132,90 L129,99 L124,103 L116,105 L107,106 L102,115 L96,121 L94,121 L94,123 L119,123 L120,127 L119,128 L-151,128 L-152,123 L-108,123 L-108,121 L-113,119 L-119,111 L-120,106 L-140,105 L-150,103 L-154,99 L-155,86 L-155,74 L-152,69 L-148,59 L-143,54 L-135,49 L-117,43 L-91,37 L-78,34 L-66,26 L-49,15 L-30,5 L-19,2 Z M6,6 L-11,7 L-25,10 L-41,18 L-56,27 L-74,39 L-90,43 L-120,50 L-133,55 L-133,56 L-114,57 L-114,62 L-120,69 L-127,73 L-148,74 L-149,75 L-149,90 L-147,97 L-140,99 L-122,99 L-120,86 L-116,78 L-107,70 L-99,67 L-85,67 L-76,71 L-70,76 L-65,84 L-63,91 L-62,99 L10,99 L10,63 L11,48 L-63,48 L-62,43 L-51,34 L-32,22 L-21,17 L-4,14 L47,14 L62,16 L72,21 L78,26 L83,34 L83,47 L78,65 L91,69 L99,75 L103,80 L107,89 L109,99 L119,98 L124,96 L126,92 L128,67 L129,61 L129,44 L126,39 L113,34 L103,27 L87,15 L76,10 L56,7 L32,6 Z M2,19 L-15,21 L-26,25 L-41,34 L-43,37 L-36,38 L-35,43 L-8,43 L9,42 L14,24 L14,19 Z M23,19 L22,20 L20,37 L20,42 L53,42 L60,41 L62,27 L62,22 L56,20 L41,19 Z M67,25 L66,26 L65,41 L77,41 L78,36 L72,28 Z M39,47 L16,48 L14,62 L14,99 L48,99 L51,85 L56,77 L64,70 L73,66 L76,58 L78,51 L78,47 Z M-141,61 L-144,64 L-145,68 L-144,69 L-131,69 L-124,66 L-120,63 L-120,61 Z M-95,75 L-105,79 L-111,86 L-113,91 L-113,103 L-110,109 L-102,116 L-96,118 L-88,118 L-78,113 L-74,108 L-71,100 L-71,93 L-74,85 L-79,80 L-85,76 Z M76,75 L68,78 L60,85 L57,93 L57,100 L61,110 L68,116 L74,118 L82,118 L90,115 L97,107 L99,102 L99,91 L95,83 L89,78 L81,75 Z M-64,106 L-70,116 L-77,122 L-77,123 L63,123 L58,118 L52,110 L50,106 Z " transform="translate(177,65)"/>\n            <path class="svg_carbody" d="M0,0 L14,0 L18,3 L19,6 L19,16 L17,20 L13,22 L1,22 L-4,18 L-5,16 L-5,5 Z M1,6 L1,14 L3,16 L12,16 L13,15 L13,7 L12,6 Z " transform="translate(273,110)"/>\n            \x3c!--- doorhandles --\x3e\n            <path class="svg_carhandles" d="M0,0 L13,0 L14,3 L13,5 L0,5 L-1,1 Z " transform="translate(234,120)"/>\n            <path class="svg_carhandles" d="M0,0 L14,0 L15,4 L14,5 L0,5 L-1,2 Z " transform="translate(167,121)"/>\n            \x3c!--- wieldop --\x3e\n            <path class="svg_carwheels" d="M0,0 L9,0 L15,4 L17,7 L18,14 L15,21 L10,25 L3,26 L-4,23 L-8,17 L-8,8 L-5,3 Z M2,6 L-2,10 L-1,17 L1,19 L8,19 L11,16 L11,10 L7,6 Z " transform="translate(80,149)"/>\n            <path class="svg_carwheels" d="M0,0 L8,0 L14,4 L17,10 L16,19 L11,24 L6,26 L-1,25 L-7,20 L-9,11 L-5,3 Z M2,6 L-2,9 L-2,16 L1,19 L5,20 L10,17 L11,11 L6,6 Z " transform="translate(251,149)"/>\n\n            <path class="svg_driver hidden" style="scale:0.8" d="M0,0 L8,3 L11,7 L12,14 L9,24 L12,27 L12,31 L-12,31 L-12,27 L-8,25 L-8,23 L-11,22 L-14,13 L-11,6 L-6,1 Z M-3,7 L-8,11 L-8,17 L-5,20 L1,20 L4,17 L4,10 L-1,7 Z M0,26 L-4,28 L5,28 L3,26 Z " transform="translate(216,105)"/>\n            <path class="svg_moving hidden" d="M0,0 L28,0 L28,4 L0,4 Z " transform="translate(339,119)"/>\n            <path class="svg_moving hidden" d="M0,0 L16,0 L18,2 L17,6 L-2,6 L-3,3 Z " transform="translate(338,130)"/>\n            <path class="svg_moving hidden" d="M0,0 L19,0 L20,4 L19,5 L0,5 L-1,1 Z " transform="translate(330,144)"/>\n\n            <path class="svg_cable hidden" d="M0,0 L9,1 L15,4 L20,9 L23,15 L24,31 L27,40 L34,46 L37,47 L46,47 L53,44 L57,39 L59,32 L59,22 L58,19 L60,15 L66,17 L65,37 L60,47 L51,53 L48,54 L36,54 L26,49 L19,41 L17,37 L17,21 L14,12 L8,8 L0,7 Z " transform="translate(286,119)"/>\n          </svg>\n          <div class="carcard_overlay" id="carcard_status">Loading...</div>\n          <div class="carcard_error hidden" id="card_error"></div>\n          <div class="carcard_battery_bar_container">\n            <div class="carcard_battery_bar_background" id="battery_bar"></div>\n            <div class="carcard_battery_bar_text" id="battery_text">0%</div>\n          </div>\n          <div class="carcard_event hidden" id="car_event"></div>\n          <div class="bottom_row">\n            <span class="hidden" id="charger_status"></span>\n            <span class="actions">\n              <button class="charge_button hidden" id="charge_toggle_btn">no action</button>\n            </span>\n          </div>\n        </div>\n    </ha-card>',this.statusEl=this.querySelector("#carcard_status"),this.batteryBar=this.querySelector("#battery_bar"),this.batteryText=this.querySelector("#battery_text"),this.chargeBtn=this.querySelector("#charge_toggle_btn"),this.eventEl=this.querySelector("#car_event"),this.chargerEl=this.querySelector("#charger_status"),this.errorEl=this.querySelector("#card_error"),this.displayInsideEl=this.querySelector(".display_inside"),this.cableEl=this.querySelector(".svg_cable"),this.chargingPowerTextEl=this.querySelector("#charging_power_text"),this._svgChargerEls=this.querySelectorAll(".svg_charger"),this._svgParkingEls=this.querySelectorAll(".svg_parking"),this._svgDriverEls=this.querySelectorAll(".svg_driver"),this._svgMovingEls=this.querySelectorAll(".svg_moving"),this.chargeBtn?this.chargeBtn.addEventListener("click",(()=>this._handleChargeToggle())):console.warn("[simple-ev-card] Charge button not found, charging controls disabled")}set hass(o){this._hass=o,this._clearError();const c=this.config.charger_connected_entity?o.states[this.config.charger_connected_entity]:void 0,h=this.config.car_battery_entity?o.states[this.config.car_battery_entity]:void 0,l=this.config.car_cruising_range_entity?o.states[this.config.car_cruising_range_entity]:void 0,L=this.config.is_charging_entity?o.states[this.config.is_charging_entity]:void 0,g=this.config.charger_status?o.states[this.config.charger_status]:void 0,d=this.config.car_charging_power_entity?o.states[this.config.car_charging_power_entity]:void 0;c||this._showError(`Entity not found: ${this.config.charger_connected_entity}`),h||this._showError(`Entity not found: ${this.config.car_battery_entity}`);const _=!(!c||!this._stateIsOn(c.state)),v=g?.state??"";let p;p=L&&void 0!==L.state?this._stateIsOn(L.state):t.some((t=>this._stateEquals(v,t)));const{isHome:f,isAway:u,isDriving:y}=this._getLocationBooleans(o,this.config,_),m=!!(this.config.car_charging_start_service&&this.config.car_charging_start_data&&this.config.car_charging_stop_service&&this.config.car_charging_stop_data);let E;E=f?_?p?n:r:e:y?i:u?s:"Unknown",this.cableEl&&this.cableEl.classList.toggle("hidden",!_);const b=E===e||E===r||E===n;if(this._toggleSvgElements(this._svgChargerEls,!b),this.chargeBtn){const t=b&&_&&m;this.chargeBtn.classList.toggle("hidden",!t)}if(this.displayInsideEl&&!this.config.car_charging_power_entity&&this.displayInsideEl.classList.toggle("green",p),this.config.car_charging_power_entity){this.displayInsideEl&&this.displayInsideEl.classList.remove("green");const t=d?.state,e=this._isValidState(t)?Number(t):null,r=null!==e&&!Number.isNaN(e)&&e>0;if(this.chargingPowerTextEl&&(r&&null!==e?(this.chargingPowerTextEl.classList.remove("hidden"),this._prevChargingPower!==e&&(this._prevChargingPower=e,this.chargingPowerTextEl.textContent=`${e.toFixed(1)} kW`)):(this.chargingPowerTextEl.classList.add("hidden"),this._prevChargingPower=null)),this.displayInsideEl&&r&&null!==e){const t=this.config.max_charging_power??11,r=Math.min(100,e/t*100);if(r>=100)this.displayInsideEl.style.clipPath="";else{const t=100-r;this.displayInsideEl.style.clipPath=`inset(${t}% 0 0 0)`}this.displayInsideEl.style.fill="#62e027ff"}else this.displayInsideEl&&(this.displayInsideEl.style.clipPath="",this.displayInsideEl.style.fill="transparent")}this._toggleSvgElements(this._svgParkingEls,E!==s);const w=E===i;if(this._toggleSvgElements(this._svgDriverEls,!w),this._toggleSvgElements(this._svgMovingEls,!w),this.statusEl&&this._prevStatus!==E&&(this._prevStatus=E,this.statusEl.textContent=E),this._prevIsCharging!==p&&(this._prevIsCharging=p,this.chargeBtn&&(this.chargeBtn.textContent=p?"Stop Charging":"Start Charging")),this.batteryBar&&this.batteryText){const t=h?.state,e=l?.state,r=this._isValidState(t)?Number(t):null,n=this._isValidState(e)?Number(e):null,s=null!==r&&!Number.isNaN(r),i=null!==n&&!Number.isNaN(n);this._prevBattery===r&&this._prevRange===n||(this._prevBattery=r,this._prevRange=n,s?(this.batteryBar.style.width=`${r}%`,this.batteryText.textContent=i?`${r}% (${n} km)`:`${r}%`,this.batteryBar.style.backgroundColor=r>50?"#4CAF50":r>20?"#FF9800":a):(this.batteryBar.style.width="0%",this.batteryText.textContent="Battery: N/A",this.batteryBar.style.backgroundColor=a))}if(this.chargerEl&&this._prevChargerStatus!==v&&(this._prevChargerStatus=v,v?(this.chargerEl.classList.remove("hidden"),this.chargerEl.textContent=v):this.chargerEl.classList.add("hidden")),this.eventEl&&this.config.calendar&&!this._carEvent){const t=Date.now(),e=3e4*Math.pow(2,this._calendarFetchAttempts),r=this._calendarFetchAttempts<3,n=t-this._calendarLastFetchTime>e;r&&n&&(this._calendarLastFetchTime=t,this._fetchCalendarEvent(o))}}async _fetchCalendarEvent(t){try{if(this.config.calendar&&await this._getCarEventToday(t,this.config.calendar),this._carEvent&&this.eventEl){this.eventEl.classList.remove("hidden");const t=this._carEvent.summary||"Event",e=this._carEvent.duration||"?";this.eventEl.textContent=`${t} (${e}h)`}}catch(t){this._calendarFetchAttempts++,console.error(`[simple-ev-card] Calendar fetch failed (attempt ${this._calendarFetchAttempts}/3)`,t),this._calendarFetchAttempts>=3&&this.eventEl&&this._showError("Calendar unavailable")}}async _getCarEventToday(t,e){if(!e)return;const r=new Date,n=new Date(r);n.setHours(23,59,59);const s=await t.callApi("GET",`calendars/${e}?start=${r.toISOString()}&end=${n.toISOString()}`);if(!Array.isArray(s))throw new Error("Calendar API returned unexpected format: expected array, got "+typeof s);const i=s.find((t=>null!==t&&"object"==typeof t&&"string"==typeof t.start&&"string"==typeof t.end));if(i&&i.start&&i.end){const t=new Date(i.start),e=new Date(i.end);if(isNaN(t.getTime())||isNaN(e.getTime()))throw new Error("Invalid date format in calendar event");const r=(e.getTime()-t.getTime())/36e5;this._carEvent={...i,duration:r.toFixed(1)}}}async _handleChargeToggle(){if(this._hass)try{if(this._prevIsCharging){const t=this._parseServiceCall(this.config.car_charging_stop_service);if(!t)return void this._showError("Stop charging service not configured correctly");if(!this.config.car_charging_stop_data)return void this._showError("Stop charging data not configured");await this._hass.callService(t.domain,t.service,this.config.car_charging_stop_data)}else{const t=this._parseServiceCall(this.config.car_charging_start_service);if(!t)return void this._showError("Start charging service not configured correctly");if(!this.config.car_charging_start_data)return void this._showError("Start charging data not configured");await this._hass.callService(t.domain,t.service,this.config.car_charging_start_data)}}catch(t){const e=this._prevIsCharging?"stop":"start";this._showError(`Failed to ${e} charging: ${t instanceof Error?t.message:"Unknown error"}`)}else this._showError("Cannot toggle charging: Home Assistant not available")}getCardSize(){return 3}}customElements.define("car-card",o);
